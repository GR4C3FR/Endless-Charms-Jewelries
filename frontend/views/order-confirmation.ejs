<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KK3P9FN7TL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KK3P9FN7TL');
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Confirmation - Endless Charms</title>
  <meta name="description" content="Thank you for your order at Endless Charms. Your custom jewelry order has been confirmed. Track your order and view details.">
  <meta name="robots" content="noindex, follow">
  <link rel="icon" href="/images/logo.png" type="image/png">
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <header class="main-header">
    <div class="container">
      <nav class="navbar">
        <a href="/" class="logo" title="Endless Charms - Premium Jewelry Store">
          <img src="/images/navigation/logo.png" alt="Endless Charms Logo" class="logo-img" loading="lazy">
        </a>
        <div class="nav-links">
          <a href="/" class="nav-link">HOME</a>
          <a href="/blogs" class="nav-link">BLOGS</a>
          <div class="nav-item">
            <span class="nav-link">SHOP</span>
            <div class="dropdown-menu">
              <a href="/engagement-rings">Engagement Rings</a>
              <a href="/wedding-bands">Wedding Bands</a>
              <a href="/accessories">Other Accessories</a>
            </div>
          </div>
          <a href="/contact" class="nav-link">CONTACT</a>
          <a href="/about" class="nav-link">ABOUT</a>
        </div>
        <div class="nav-icons">
          <button class="icon-btn" onclick="handleBagClick()">
            <img src="/images/navigation/bag.png" alt="Shopping Bag" class="bag-icon">
            <span class="bag-badge" style="display: none;">0</span>
          </button>
        </div>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:100px; padding-bottom:40px;">
    <h1>Thank you ‚Äî your order is placed</h1>
    <div id="order-summary" style="margin-top:18px;">
      <p>Loading order details‚Ä¶</p>
    </div>
    <div style="margin-top:18px;">
      <a href="/" class="cta-button">Back to Home</a>
      <a href="/bag" class="cta-button outline" style="margin-left:12px;">View Bag</a>
    </div>
  </main>

  <!-- Footer (copied from home) -->
  <footer class="main-footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <img src="/images/endless-charms-logo-transparent.png" alt="Endless Charms" class="footer-logo-img">
          <p>100% authentic and pawnable gold,<br>secure payments, and fully<br>customizable made-to-order pieces.</p>
          <p class="copyright">¬© Copyright 2025</p>
        </div>
        
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul class="footer-links">
            <li><a href="/">Home</a></li>
            <li><a href="/blogs">Blogs</a></li>
            <li><a href="/contact">Contact</a></li>
            <li><a href="/about">About</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h4>Collections</h4>
          <ul class="footer-links">
            <li><a href="/engagement-rings">Engagement Rings</a></li>
            <li><a href="/wedding-bands">Wedding Bands</a></li>
            <li><a href="/accessories">Other Accessories</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h4>Contacts</h4>
          <p>endlesscharmsofficial@gmail.com</p>
          <p>+63 916 430 5638</p>
          <div class="social-links">
            <a href="https://www.facebook.com/profile.php?id=100079908461494" target="_blank" class="social-icon">FB</a>
            <a href="https://www.instagram.com/endless_charms/" target="_blank" class="social-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Login Required Modal -->
  <div id="loginRequiredModal" class="modal" style="display: none;">
    <div class="modal-content login-modal">
      <span class="close-modal" onclick="closeLoginModal()">&times;</span>
      <h2>Login Required</h2>
      <p id="loginModalMessage">Please log in to continue.</p>
      <div class="modal-buttons">
        <button class="primary-btn" onclick="window.location.href='/login'">Log In</button>
        <button class="secondary-btn" onclick="window.location.href='/signup'">Sign Up</button>
      </div>
    </div>
  </div>

  <script src="/js/script.js"></script>
  <script>
    (async function(){
      const el = document.getElementById('order-summary');
      
      try {
        // Get order number from URL query param or sessionStorage
        const urlParams = new URLSearchParams(window.location.search);
        const orderNumber = urlParams.get('order');
        const sessionData = sessionStorage.getItem('ec_last_order');
        let orderInfo = sessionData ? JSON.parse(sessionData) : null;
        
        if (!orderNumber && !orderInfo) {
          if (el) el.innerHTML = '<p>No recent order found. <a href="/">Return to homepage</a></p>';
          return;
        }
        
        // Show loading state
        if (el) el.innerHTML = '<p>Loading your order details...</p>';
        
        // Fetch order details from backend API
        const orderIdToFetch = orderNumber || orderInfo?.orderNumber || orderInfo?.orderId;
        
        try {
          const response = await fetch(`/api/orders/number/${orderIdToFetch}`, {
            credentials: 'include'
          });
          
          if (response.ok) {
            const order = await response.json();
            displayOrder(order);
            // Clear sessionStorage after successful display
            sessionStorage.removeItem('ec_last_order');
          } else {
            // Fallback to sessionStorage data if API fails
            if (orderInfo) {
              displayBasicOrder(orderInfo);
            } else {
              if (el) el.innerHTML = '<p>Could not load order details. Please check your orders in your <a href="/profile?tab=orders">profile</a>.</p>';
            }
          }
        } catch (fetchErr) {
          console.error('Fetch error:', fetchErr);
          // Fallback to sessionStorage data
          if (orderInfo) {
            displayBasicOrder(orderInfo);
          } else {
            if (el) el.innerHTML = '<p>Could not connect to server. Please check your orders in your <a href="/profile?tab=orders">profile</a>.</p>';
          }
        }
        
      } catch(e) { 
        console.error('Order confirmation error:', e); 
        if (el) el.innerHTML = '<p>An error occurred. Please check your orders in your <a href="/profile?tab=orders">profile</a>.</p>';
      }
      
      function displayOrder(order) {
        let html = '<div class="order-confirmation-details">';
        html += `<p class="order-number"><strong>Order Number:</strong> <span class="highlight">${order.orderNumber || order._id}</span></p>`;
        html += `<p><strong>Order Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>`;
        html += `<p><strong>Status:</strong> <span class="status-badge ${order.status}">${order.status || 'Processing'}</span></p>`;
        
        // Shipping address
        if (order.shippingAddress) {
          const addr = order.shippingAddress;
          html += '<div class="shipping-info" style="margin-top:16px; padding:12px; background:#f9f9f9; border-radius:8px;">';
          html += '<strong>üì¶ Shipping To:</strong><br>';
          html += `<span>${addr.fullName || ''}</span><br>`;
          html += `<span>${addr.address || [addr.street, addr.barangay, addr.city, addr.province].filter(Boolean).join(', ')}</span><br>`;
          if (addr.phone) html += `<span>üìû ${addr.phone}</span>`;
          html += '</div>';
        }
        
        // Order items
        if (order.items && order.items.length) {
          html += '<div class="items-ordered" style="margin-top:16px;">';
          html += '<strong>üõçÔ∏è Items Ordered:</strong>';
          html += '<ul style="list-style:none; padding:0; margin-top:8px;">';
          order.items.forEach(it => {
            const itemTotal = (it.price || 0) * (it.quantity || 1);
            html += `<li style="padding:8px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">`;
            html += `<span>${it.name} √ó ${it.quantity}</span>`;
            html += `<span>‚Ç±${itemTotal.toLocaleString()}</span>`;
            html += `</li>`;
          });
          html += '</ul></div>';
        }
        
        // Total
        html += `<div class="order-total" style="margin-top:16px; padding-top:12px; border-top:2px solid #333; font-size:1.2em;">`;
        html += `<strong>Total:</strong> <span style="color:#8B4513;">‚Ç±${(order.total || 0).toLocaleString()}</span>`;
        html += '</div>';
        
        // Payment info
        if (order.paymentInfo) {
          html += `<p style="margin-top:12px; color:#666;"><small>Payment Method: ${order.paymentInfo.method || 'N/A'}</small></p>`;
        }
        
        html += '</div>';
        
        if (el) el.innerHTML = html;
      }
      
      function displayBasicOrder(orderInfo) {
        let html = '<div class="order-confirmation-details">';
        html += `<p class="order-number"><strong>Order Number:</strong> <span class="highlight">${orderInfo.orderNumber || orderInfo.orderId}</span></p>`;
        html += `<p><strong>Order Date:</strong> ${new Date(orderInfo.createdAt).toLocaleString()}</p>`;
        html += `<p><strong>Total:</strong> <span style="color:#8B4513;">‚Ç±${(orderInfo.total || 0).toLocaleString()}</span></p>`;
        html += '<p style="margin-top:16px;">View full order details in your <a href="/profile?tab=orders">profile</a>.</p>';
        html += '</div>';
        
        if (el) el.innerHTML = html;
        sessionStorage.removeItem('ec_last_order');
      }
    })();
  </script>
</body>
</html>